# Malware Incident Response Playbook

## Incident Classification: Malware Infection

### Severity Levels
- **Critical**: Ransomware, data destruction, C2 communication
- **High**: Persistent malware, credential theft, lateral movement
- **Medium**: Adware, potentially unwanted programs (PUPs)
- **Low**: False positives, low-impact infections

## Phase 1: Preparation (Pre-Incident)

### Prerequisites
- [ ] Incident response team contacts updated
- [ ] Backup systems verified and tested
- [ ] Forensic tools and storage prepared
- [ ] Network segmentation capabilities ready
- [ ] Communication templates prepared

### Tools and Resources
```bash
# Essential forensic tools
- Volatility (memory analysis)
- YARA (malware pattern matching)
- Wireshark (network analysis)
- Autopsy (disk forensics)
- SIFT Workstation (forensic distribution)
```

### Team Roles
- **Incident Commander**: Overall coordination and decisions
- **Forensic Analyst**: Evidence collection and analysis
- **Network Administrator**: Network isolation and monitoring
- **Security Analyst**: Threat intelligence and IOC analysis
- **Communications Lead**: Stakeholder and external communications

## Phase 2: Identification

### Initial Triage (0-30 minutes)
```yaml
Priority Actions:
1. Verify the incident - Rule out false positives
2. Assess scope - Single host or multiple systems?
3. Determine impact - Critical systems affected?
4. Document timeline - When was infection first detected?
5. Preserve evidence - Create forensic images if possible
```

### Detection Sources
- **Antivirus alerts**: Check AV logs for detection details
- **EDR/XDR alerts**: Behavioral analysis findings
- **Network monitoring**: Unusual traffic patterns
- **User reports**: Suspicious system behavior
- **SIEM alerts**: Correlated security events

### Initial Assessment Checklist
- [ ] Malware family identified (if possible)
- [ ] Infection vector determined
- [ ] Affected systems inventoried
- [ ] Data at risk assessed
- [ ] Business impact evaluated

## Phase 3: Containment

### Immediate Containment (30-60 minutes)
```bash
# Network isolation commands
# Block C2 communication
iptables -A OUTPUT -d [C2_IP] -j DROP
# Isolate infected host
iptables -A INPUT -s [INFECTED_IP] -j DROP
iptables -A OUTPUT -d [INFECTED_IP] -j DROP

# Windows isolation
netsh advfirewall set allprofiles firewallpolicy blockinbound,blockoutbound
# Disable network adapter
wmic path win32_networkadapter where index=1 call disable
```

### Short-term Containment
1. **Network Segmentation**
   - Move infected systems to isolated VLAN
   - Block known malicious IPs/domains
   - Monitor network traffic for lateral movement

2. **System Isolation**
   - Disconnect from network (maintain power)
   - Document running processes and network connections
   - Create memory dump before shutdown

3. **Account Security**
   - Disable compromised user accounts
   - Force password resets for affected users
   - Review privileged account access

### Long-term Containment
- Deploy additional monitoring on unaffected systems
- Implement enhanced logging and alerting
- Coordinate with ISP for upstream blocking
- Update security tools with new IOCs

## Phase 4: Eradication

### Malware Analysis
```python
# YARA rule for detection
rule MalwareFamily_Variant {
    meta:
        description = "Detects specific malware variant"
        author = "Security Team"
        date = "2024-01-01"
    
    strings:
        $string1 = "malicious_string" ascii
        $string2 = { 48 65 6C 6C 6F } // "Hello" in hex
        
    condition:
        any of ($string*)
}
```

### Removal Procedures
1. **Safe Mode Boot**
   - Boot infected systems in safe mode
   - Run multiple antivirus scanners
   - Check for persistence mechanisms

2. **Registry Cleanup**
   ```cmd
   # Common persistence locations
   reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Run
   reg query HKCU\Software\Microsoft\Windows\CurrentVersion\Run
   reg query HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce
   ```

3. **File System Cleanup**
   - Remove malicious files and folders
   - Clean temporary directories
   - Verify system file integrity

4. **Service Cleanup**
   ```cmd
   # Check for malicious services
   sc query state= all
   # Remove suspicious services
   sc delete [malicious_service_name]
   ```

### Verification Steps
- [ ] Multiple AV scans show clean results
- [ ] No suspicious network connections
- [ ] System performance returned to normal
- [ ] All persistence mechanisms removed
- [ ] Critical system files verified

## Phase 5: Recovery

### System Restoration
1. **Backup Restoration**
   - Restore from clean, verified backups
   - Scan restored files before deployment
   - Verify backup integrity and timestamps

2. **System Rebuilding**
   - Complete OS reinstallation if necessary
   - Apply latest security patches
   - Reinstall applications from clean sources

3. **Security Hardening**
   - Update antivirus definitions
   - Configure enhanced monitoring
   - Implement additional security controls

### Validation Testing
```bash
# Network connectivity tests
ping -c 4 8.8.8.8
nslookup google.com

# Application functionality tests
curl -I https://internal-app.company.com
# Database connectivity
mysql -u user -p -e "SELECT 1"
```

### Monitoring Enhancement
- Deploy additional EDR agents
- Configure behavioral monitoring rules
- Implement file integrity monitoring
- Set up canary tokens for early detection

## Phase 6: Lessons Learned

### Post-Incident Analysis
1. **Timeline Reconstruction**
   - Document complete attack timeline
   - Identify missed detection opportunities
   - Analyze response effectiveness

2. **Root Cause Analysis**
   - Determine initial infection vector
   - Identify security control failures
   - Assess user awareness gaps

3. **Impact Assessment**
   - Quantify business impact
   - Calculate financial losses
   - Measure operational disruption

### Improvement Recommendations
- **Technical Controls**
  - Update security tool configurations
  - Implement additional monitoring
  - Enhance network segmentation

- **Process Improvements**
  - Update incident response procedures
  - Revise escalation criteria
  - Improve communication protocols

- **Training Needs**
  - Conduct security awareness training
  - Perform tabletop exercises
  - Update technical team skills

## Evidence Collection Procedures

### Memory Acquisition
```bash
# Linux memory dump
sudo dd if=/dev/mem of=/path/to/memory.dump bs=1M
# Alternative with lime
sudo insmod lime.ko "path=/path/to/memory.lime format=lime"

# Windows memory dump (Admin PowerShell)
DumpIt.exe /output memory.dmp
```

### Disk Imaging
```bash
# Create forensic image
dd if=/dev/sda of=/evidence/disk_image.dd bs=64K conv=noerror,sync

# Verify integrity
md5sum /evidence/disk_image.dd > disk_image.md5
sha256sum /evidence/disk_image.dd > disk_image.sha256
```

### Network Evidence
```bash
# Capture network traffic
tcpdump -i eth0 -w /evidence/network_capture.pcap

# Export firewall logs
iptables -L -n -v > /evidence/firewall_logs.txt

# DNS query logs
journalctl -u systemd-resolved > /evidence/dns_logs.txt
```

### Chain of Custody
- Document evidence collection time and personnel
- Maintain secure storage of evidence
- Preserve original evidence integrity
- Document all analysis performed

## Communication Templates

### Internal Notification
```
SUBJECT: SECURITY INCIDENT - Malware Detection [CASE-ID]

Initial Details:
- Detection Time: [TIMESTAMP]
- Affected Systems: [SYSTEM_LIST]
- Malware Type: [TYPE_IF_KNOWN]
- Current Status: [STATUS]
- Estimated Impact: [IMPACT_LEVEL]

Actions Taken:
- [ACTION_1]
- [ACTION_2]

Next Steps:
- [NEXT_STEP_1]
- [NEXT_STEP_2]

Point of Contact: [INCIDENT_COMMANDER]
```

### Executive Summary
```
EXECUTIVE BRIEFING - Security Incident

SITUATION:
- Malware infection detected on [X] systems
- [BRIEF_DESCRIPTION_OF_IMPACT]

ACTIONS TAKEN:
- Infected systems isolated
- Malware eradication in progress
- Business operations [STATUS]

TIMELINE:
- Expected resolution: [TIMEFRAME]
- Full report available: [TIMEFRAME]

BUSINESS IMPACT:
- [QUANTIFIED_IMPACT]
- [MITIGATION_MEASURES]
```

## Key Performance Indicators (KPIs)

### Response Metrics
- **Mean Time to Detection (MTTD)**: < 4 hours
- **Mean Time to Containment (MTTC)**: < 2 hours
- **Mean Time to Recovery (MTTR)**: < 24 hours
- **False Positive Rate**: < 5%

### Success Criteria
- [ ] All malware eradicated
- [ ] No data exfiltration detected
- [ ] Business operations restored
- [ ] Lessons learned documented
- [ ] Security controls improved

## Emergency Contacts

### Internal Team
- **Incident Commander**: [PHONE] [EMAIL]
- **CISO**: [PHONE] [EMAIL]
- **IT Manager**: [PHONE] [EMAIL]
- **Legal**: [PHONE] [EMAIL]

### External Resources
- **Cyber Insurance**: [POLICY_NUMBER] [PHONE]
- **FBI IC3**: https://ic3.gov
- **Third-party IR Firm**: [CONTACT_INFO]
- **Vendor Support**: [VARIOUS_CONTACTS]